### Create module operator

>>NOTE: Refer to the [template-operator](https://github.com/kyma-project/template-operator#implementation) that serves as a reference to implement a module (component) operator compatible with the lifecycle-manager. 

This boils down to:
 - creating a repository for your module on github and cloning it locally on your machine (github.com/{your-org}/sample-kyma-module.git in the following example) 
 - in the module folder, using [kubebuilder](https://book.kubebuilder.io/quick-start.html) to initialize scaffold of the project and create module API (here `sample.operator.kyma-project.io/v1alpha1` Custom Resource Definition) and generating empty controller to put reconciliation logic for it.

For example:
```bash
 kubebuilder init --domain kyma-project.io --repo github.com/{your_organisation}/sample-kyma-module.git 
 kubebuilder create api --group operator --version v1alpha1 --kind Sample
```

Generate manifests via dedicated make target
```bash
 make manifests
```

>>NOTE: If your module should be installed in kyma-system namespace, change the target namespace in the `config/default/kustomization.yaml` to `kyma-system`
and remove namespace definition from `config/manager/manager.yaml` manifest (not to include kyma-system in your module resources)


  - Define your API (CRD) and implement reconciliation logic. 
  - Make sure to fulfil the contract towards lifecycle manager (i.e [status requirements](https://github.com/kyma-project/template-operator/blob/main/api/v1alpha1/status.go)).
  - configure RBACS 

 Run and test it locally on your machine using make targets generated by kubebuilder (`make build`, `make test`, `make run`).
 
 ### Deploy and verify on kubernetes

 - build docker image for the controller and push it to the docker registry


 ```bash
  make docker-build docker-push IMG=<some-registry>/sample-kyma-module:tag
 ```
 - deploy and verify on kubernetes (i.e locally on k3d)
 
 ```
 make deploy
 ```

 Building docker image and pushing it to the registry should be automated and regularly executed in the development worflow (i.e when merging changes to main branch (new image tag per commit to main ) or when creating github releases (new image tag per github release))

 ### Generate module manifest

Add the following make target to Makefile:
```
.PHONY: generate-manifest
generate-manifest: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.
	cd config/manager && $(KUSTOMIZE) edit set image controller=${IMG}
	$(KUSTOMIZE) build config/default > manifest.yaml
```

Generate module manifest:
```
make generate-manifest IMG=<some-registry>/sample-kyma-module:tag
```
This will generate a `manifest.yaml` file containing all kubernetes resources your module operator relies on. The IMG value will be used as the operator's deployment image.
Now you can deploy your module operator and the sample Sample CR with the following command


```bash
kubectl create ns kyma-system # <-- only if this namespace doesnt exist yet on the cluster

kubectl apply -f manifest.yaml
kubectl apply -f config/samples/operator_v1alpha1_sample.yaml
```
These two manifests should be published as release artefacts so that your module users could easily access those related with latest version.

### Generate module template

In order to allow enabling your module via kyma lifecycle manager you need to generate a module-template

!!! This part will be changed !!! Neighbours will add a pipeline for module contributors that will generate module template ----- 

```bash
kyma alpha create module --channel=fast --name kyma-project.io/module/sample --version 0.0.1 --path . --registry {docker registry URL} --output=sample-fast.yaml
```

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -----

### Test with local lifecycle manager

You need a kubernetes instance with lifecycle manager installed. The following installs lifecycle manager on the target cluster 
```
kyma alpha deploy
```
Next, you should apply your module template and enable it in Kyma
```
kubeclt apply -f sample-fast.yaml
kyma alpha enable module sample -c fast
```

Verify installation. Kyma CR and Sample CR should eventually resolve statuses to "Ready" 
```
kubectl get kymas -Aw
```
```
kubectl get samples -Aw
```
### Test your module on single managed kyma instance on Canary landscape

 - create kyma instance on Canary landscape
 - connect to the instance via kubectl
 - apply module template locally on the cluster
 ```
 kubeclt apply -f sample-fast.yaml
 ```
 - enable your module by editing Kyma CR locally on the cluster
 ```
 kubectl edit kymas.operator.kyma-project.io -n kyma-system default-kyma
 ```
to add
```
- channel: fast
  name: sample
  remoteModuleTemplateRef: sample
```
in the `spec.modules` section.
 - Verify installation
Kyma CR and Sample CR should eventually resolve statuses to "Ready" 
```
kubectl get kymas -Aw
```
```
kubectl get samples -Aw
```


### Submit Module Template to the fast release channel 

Before you can make your module globally available is has to go through evaluation phase as BETA module
The evaluation period length must be agreed with Kyma stakeholders.

Create a pull request to the `https://github.tools.sap/kyma/kyma-modules/tree/main/fast` introducing module template yaml file for your module. 
Use `"operator.kyma-project.io/beta": "true"` and `"operator.kyma-project.io/internal": "true"` labels to indicate that your module is still in pre-GA phase:
 - only available for internally for SAP teams
 - as BETA feature ( with "best effort" SLA)



### GO GA!

Once the evaluation period has finished (your module was available on Canary as BETA w/o major issues) the module needs to be a subject of readiness checks defined in the govenrnance model:
   
 - your module needs to be ready to face all customers of managed Kyma runtimes and fulfil the operation support duties (Support&Operations readiness check)
 - your module needs to fulfil all product standards
 - your module needs to fulfil required monitoring & alerting rules

When all readiness checks are satisfied you can clear those pre-GA flags. Remove the `"operator.kyma-project.io/beta": "true"` and `"operator.kyma-project.io/internal": "true"` labels in the module template in `https://github.tools.sap/kyma/kyma-modules`. Congrats, you're live with your module.

