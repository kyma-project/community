# Replacement of Pod Security Policies

## Intro

Pod Security Policies as a toolset to ensure compliance with dedicated Pod settings will be no longer part of Kubernetes in version 1.25. As a replacement, Kubernetes introduced the so called [Pod Security Standards](https://kubernetes.io/docs/concepts/security/pod-security-standards) and an admission controller ([Pod Security Admission](https://kubernetes.io/docs/concepts/security/pod-security-admission/)) to enforce the Pod Security Standards. The Pod Security Standard contains 3 different standards: unrestricted, baseline and restricted. While the first standard has no restrictions (like the name say's), the other 2 contain different security settings.

## Kyma Pod Security Policies

Most of the Pod Security Policies of Kyma are not as restrictive as the baseline or the restricted standard. Because of this, the Kyma related workloads can have specifications which are not compatible with the baseline or the restricted standard.

## Create secure Pod specifications

Pod Security Policies as well as Pod Security Standards are enforced via a so called Admission controller. This means, that the rules are validated and further actions are taken immediately before the Pod will be deployed. A mechanism like this works very well to ensure compliance with some rules but secure Pod specifications must be created earlier. In an optimal setup, the Pod specifications ensure the same or a better security level than the compliance rules. If this is the case, deployments will never fail because of insecure or incompliant Pods or Containers.

## Summary

To decide whether we can activate the Pod Security Standards on the kyma-system Namespace or not and which level we can use, we have to check the existing Pod specifications against the Pod Security Standards. If the Pod specification doesn't meet the requirements, we should try to change the existing Pod specification to implement the most secure setting (see chapter [Create secure Pod specifications](#create-secure-pod-specifications)). To support the teams to decide if the specification files are compatible and to change the specifications if possible, we have created 2 Pod specification templates containing the security relevant entries to be compliant with the respective standard.

- [Pod Security Standard - baseline level](baseline-pod-spec.yaml)
- [Pod Security Standard - restricted level](restricted-pod-spec.yaml)

## Differences between baseline and restricted

| Control                  | Baseline                                                                                                                                                                                                                                                                | Restricted                                                                                                                                                                                                                                   |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Volume Types             | HostPath volumes are forbidden                                                                                                                                                                                                                                          | Only dedicated volume types allowed<br>- csi<br>- downwardAPI<br>- configMap<br>- emptyDir<br>- ephemeral<br>- persistendVolumeClaim<br>- projected<br>- secret                                                                              |
| Privilege Escalation     | No opinion                                                                                                                                                                                                                                                              | Privilege escalation is not allowed<br><br>`spec.<anycontainer>[*].securityContext.allowPrivilegeEscalation = false`                                                                                                                         |
| Running as Non-root      | No opinion                                                                                                                                                                                                                                                              | Containers must be required to run as non-root users<br><br>`spec.<anycontainer>[*].securityContext.runAsNonRoot = true`                                                                                                                     |
| Running as Non-root user | No Opinion<br><br>If this setting is needed, it should never been set to 0 because this is the ID of the root user.                                                                                                                                                     | Containers must set runAsUser to a value different from 0, optimal are values > 10000 to limit frictions with existing user accounts<br><br>`spec.securityContext.runAsUser != 0`<br>`spec.<anycontainer>[*].securityContext.runAsUser != 0` |
| Seccomp                  | Optional<br><br>Allowed values are:<br>- RuntimeDefault<br>- Localhost                                                                                                                                                                                                  | Mandatory<br><br>Allowed values are:<br>- RuntimeDefault<br>- Localhost                                                                                                                                                                      |
| Capabilities             | Only additional capabilities from the list below are allowed.<br><br>- Undefined/nil<br>- AUDIT_WRITE<br>- CHOWN<br>- DAC_OVERRIDE<br>- FOWNER<br>- FSETID<br>- KILL<br>- MKNOD<br>- NET_BIND_SERVICE<br>- SETFCAP<br>- SETGID<br>- SETPCAP<br>- SETUID<br>- SYS_CHROOT | Containers must drop ALL capabilities, and are only permitted to add back the NET_BIND_SERVICE capability.                                                                                                                                   |
