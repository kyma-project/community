# Replacement of Pod Security Policies

## Overview

Pod Security Policies as a toolset to ensure compliance with dedicated Pod settings is no longer part of Kubernetes in version 1.25. As a replacement, Kubernetes introduced the so-called [Pod Security Standards](https://kubernetes.io/docs/concepts/security/pod-security-standards) and an admission controller ([Pod Security Admission](https://kubernetes.io/docs/concepts/security/pod-security-admission/)) to enforce the Pod Security Standards. The Pod Security Standard contains 3 different standards: unrestricted, baseline and restricted. While the first standard has no restrictions, the other 2 contain different security settings.

## Kyma Pod Security Policies

Most of the Pod Security Policies of Kyma are not as restrictive as the baseline or the restricted standard. Because of this, the Kyma related workloads can have specifications which are not compatible with the baseline or the restricted standard.

## Create secure Pod specifications

Pod Security Policies as well as Pod Security Standards are enforced via a so-called Admission controller. This means, that the rules are validated and further actions are taken immediately before the Pod is deployed. A mechanism like this works very well to ensure compliance with some rules but secure Pod specifications must be created earlier. In an optimal setup, the Pod specifications ensure the same or a better security level than the compliance rules. If this is the case, deployments never fail because of insecure or non-compliant Pods or Containers.

## Compliance with Pod Security Standards

Since we don't know at the moment, if we are able to activate the baseline or restricted Pod Security Standards, we have to take some actions in order to get detailed information about the existing Pod specifications. Because of this, each team has to perform the following steps:

1. Check the workloads you are responsible for, whether they fullfil the requirements of the restricted Pod Security Standard. You can use the [Pod Security Standard - restricted level template](restricted-pod-spec.yaml) for this. If the specification doesn't fulfill the requirement, go ahead with the next action.
2. Try to apply the directives from the [Pod Security Standard - restricted level template](restricted-pod-spec.yaml) in order to fullfil the restricted standard. If you can apply the settings, you are done. Otherwise go ahead with the next action.
3. Check the workloads you are responsible for, whether they fullfil the requirements of the baseline Pod Security Standard. You can use the [Pod Security Standard - baseline level template](baseline-pod-spec.yaml) for this. If the specification doesn't fulfill the requirement, go ahead with the next action.
4. Try to apply the directives from the [Pod Security Standard - baseline level template](baseline-pod-spec.yaml) in order to fullfil the baseline standard. If you can apply the settings, you are done. Otherwise go ahead with the next action.
5. Try to apply the most restrictive Security settings possible for your workload.

After you finished the actions above, please document the outcome. In particular you have to document, which actions are completed successfully and in case you reached step 5, which settings are applied.

## Differences between baseline and restricted standards

| Control                  | Baseline                                                                                                                                                                                                                                                                | Restricted                                                                                                                                                                                                                                   |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Volume Types             | HostPath volumes are forbidden                                                                                                                                                                                                                                          | Only dedicated volume types allowed<br>- csi<br>- downwardAPI<br>- configMap<br>- emptyDir<br>- ephemeral<br>- persistentVolumeClaim<br>- projected<br>- secret                                                                              |
| Privilege Escalation     | No opinion                                                                                                                                                                                                                                                              | Privilege escalation is not allowed<br><br>`spec.<anycontainer>[*].securityContext.allowPrivilegeEscalation = false`                                                                                                                         |
| Running as Non-root      | No opinion                                                                                                                                                                                                                                                              | Containers must be required to run as non-root users<br><br>`spec.<anycontainer>[*].securityContext.runAsNonRoot = true`                                                                                                                     |
| Running as Non-root user | No Opinion<br><br>If this setting is needed, you should not set it to 0 because this is the ID of the root user.                                                                                                                                                     | Containers must set runAsUser to a value different from 0, values > 10000 are optimal to limit frictions with existing user accounts<br><br>`spec.securityContext.runAsUser != 0`<br>`spec.<anycontainer>[*].securityContext.runAsUser != 0` |
| Seccomp                  | Optional<br><br>Allowed values are:<br>- RuntimeDefault<br>- Localhost                                                                                                                                                                                                  | Mandatory<br><br>Allowed values are:<br>- RuntimeDefault<br>- Localhost                                                                                                                                                                      |
| Capabilities             | Only additional capabilities from the list below are allowed.<br><br>- Undefined/nil<br>- AUDIT_WRITE<br>- CHOWN<br>- DAC_OVERRIDE<br>- FOWNER<br>- FSETID<br>- KILL<br>- MKNOD<br>- NET_BIND_SERVICE<br>- SETFCAP<br>- SETGID<br>- SETPCAP<br>- SETUID<br>- SYS_CHROOT | Containers must drop ALL capabilities, and are only permitted to add back the NET_BIND_SERVICE capability.                                                                                                                                   |
